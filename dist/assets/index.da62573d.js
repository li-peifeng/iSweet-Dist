import{ce as se,aO as _,V as C,b as G,ca as g,cf as b,e as re,h as e,aL as N,bi as w,cg as ae,ch as ie,ci as le,Y as j,a as ce,k as ue,m as u,cj as ge,b1 as P,o as de,a8 as he,bW as R,az as pe,bV as me,S as m,I as A,b3 as K,a7 as fe,O as we,aw as be,C as E,bt as Se,aC as ke,n as f,bj as $e,ck as D}from"./index.7c455695.js";import{F as Ce,f as _e,a as Ie,S as ye,g as ve}from"./index.5fd933b3.js";import{s as Le,g as xe,a as Oe}from"./webauthn-json.browser-ponyfill.1c672167.js";const Pe="https://github.com/alist-org/alist";function Re(i){return se(`${i}-${Pe}`)}const Ae=()=>{const i=_("sso_login_enabled"),I=C("sso_login_platform"),n=_("sso_compatibility_mode"),{searchParams:l,to:S}=G(),s=l.token;s!=null&&s!=""&&(g(s),S(decodeURIComponent(l.redirect||b||"/"),!0));function d(r){const o=r.data;o.token&&(g(o.token),S(decodeURIComponent(l.redirect||b||"/"),!0))}if(window.addEventListener("message",d),re(()=>{window.removeEventListener("message",d)}),i){const r=()=>{const c=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=c;return}window.open(c,"authPopup","width=500,height=600")};let o;switch(I){case"Github":o=_e;break;case"Microsoft":o=le;break;case"Google":o=ie;break;case"Dingtalk":o=ae;break;default:o=Ce}return e(N,{cursor:"pointer",boxSize:"$8",as:o,p:"$0_5",onclick:r})}},Ue=()=>{const i=C("logo").split(`
`),I=j(i[0],i.pop()),n=ce(),l=ue(()=>`${C("site_title")}`);Ie(l);const S=j("white","$neutral1"),[s,d]=u(localStorage.getItem("username")||""),[r,o]=u(localStorage.getItem("password")||""),[c,M]=u(""),[k,V]=u(!1),[$,B]=ge("remember-pwd","false"),[y,T]=u(!1),[W,H]=P(async()=>y()?w.post("/auth/login/ldap",{username:s(),password:r(),otp_code:c()}):w.post("/auth/login/hash",{username:s(),password:Re(r()),otp_code:c()})),[,J]=P((t,a,h)=>w.post("/authn/webauthn_finish_login?username="+h,JSON.stringify(a),{headers:{session:t}})),[,q]=P(t=>w.get("/authn/webauthn_begin_login?username="+t)),{searchParams:v,to:L}=G(),Y=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,Q=_("webauthn_login_enabled"),X=async()=>{V(!k())},U=async t=>{if(!Le()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await Y())return;g();const a=t?"":s();!t&&$()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const h=await q(a);$e(h,async F=>{try{const p=xe(F.options);t&&(p.mediation="conditional");const te=await Oe(p),ne=await J(F.session,te,a);D(ne,oe=>{f.success(n("login.success")),g(oe.token),L(decodeURIComponent(v.redirect||b||"/"),!0)})}catch(p){p instanceof Error&&f.error(p.message)}})},x=async()=>{if(k())await U();else{$()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",r())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await H();D(t,a=>{f.success(n("login.success")),g(a.token),L(decodeURIComponent(v.redirect||b||"/"),!0)},(a,h)=>{!O()&&h===402?Z(!0):f.error(a)})}},[O,Z]=u(!1),z=_("ldap_login_enabled"),ee=C("ldap_login_tips");return z&&T(!0),de(()=>{U(!0)}),e(ke,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(he,{get bgColor(){return S()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(R,{alignItems:"center",justifyContent:"space-around",get children(){return[e(pe,{mr:"$2",boxSize:"$12",get src(){return I()}}),e(me,{color:"$info9",fontSize:"$2xl",get children(){return l()}})]}}),e(m,{get when(){return!O()},get fallback(){return e(A,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return c()},onInput:t=>M(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&x()}})},get children(){return[e(A,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return s()},onInput:t=>d(t.currentTarget.value)}),e(m,{get when(){return!k()},get children(){return e(A,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return r()},onInput:t=>o(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&x()}})}}),e(R,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(K,{get checked(){return $()==="true"},onChange:()=>B($()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(fe,{color:"$success9",as:we,href:"https://peifeng.li/cloud-help",get children(){return n("login.help")}})]}})]}}),e(be,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!k()},get children(){return[e(E,{w:"$full",colorScheme:"danger",onClick:()=>{g(),L(decodeURIComponent(v.redirect||b||"/"),!0)},get children(){return n("login.use_guest")}}),e(E,{colorScheme:"warning",w:"$full",onClick:()=>{O()?M(""):(d(""),o(""))},get children(){return n("login.clear")}})]}}),e(E,{colorScheme:"success",w:"$full",get loading(){return W()},onClick:x,get children(){return n("login.login")}})]}}),e(m,{when:z,get children(){return e(K,{w:"$full",get checked(){return y()===!0},onChange:()=>T(!y()),children:ee})}}),e(R,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(ye,{}),e(Ae,{}),e(m,{when:Q,get children(){return e(N,{cursor:"pointer",boxSize:"$8",as:ve,p:"$0_5",onclick:X})}}),e(Se,{})]}})]}})}})};export{Ue as default};
