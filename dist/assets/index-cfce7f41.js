import{c6 as ae,ad as I,V as _,b as B,c1 as p,c7 as b,e as ie,h as e,aM as V,bh as w,c8 as le,c9 as ce,ca as ue,Y as N,a as ge,k as de,m as d,cb as pe,b0 as P,o as he,a8 as me,bN as R,aA as fe,bM as we,S as m,I as O,b2 as G,a7 as be,O as Se,ax as $e,C as T,bs as ke,aD as Ce,n as f,bi as _e,cc as j}from"./index-76a5a9ef.js";import{F as Ie,f as ye,a as ve,S as xe,g as Le}from"./index-6dc697b4.js";import{s as Ae,g as Ee,a as Me}from"./webauthn-json.browser-ponyfill-f2f06d6e.js";const Pe="https://github.com/alist-org/alist";function Re(l){return ae(`${l}-${Pe}`)}const Oe=()=>{const l=I("sso_login_enabled"),y=_("sso_login_platform"),n=I("sso_compatibility_mode"),{searchParams:c,to:S}=B(),s=c.token;s!=null&&s!=""&&(p(s),S(decodeURIComponent(c.redirect||b||"/"),!0));function h(a){const o=a.data;o.token&&(p(o.token),S(decodeURIComponent(c.redirect||b||"/"),!0))}if(window.addEventListener("message",h),ie(()=>{window.removeEventListener("message",h)}),l){const a=()=>{const u=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=u;return}window.open(u,"authPopup","width=500,height=600")};let o;switch(y){case"Github":o=ye;break;case"Microsoft":o=ue;break;case"Google":o=ce;break;case"Dingtalk":o=le;break;default:o=Ie}return e(V,{cursor:"pointer",boxSize:"$8",as:o,p:"$0_5",onclick:a})}},ze=()=>{const l=_("logo").split(`
`),y=N(l[0],l.pop()),n=ge(),c=de(()=>`${_("site_title")}`);ve(c);const S=N("white","$neutral1"),[s,h]=d(localStorage.getItem("username")||""),[a,o]=d(localStorage.getItem("password")||""),[u,U]=d(""),[$,H]=d(!1),[k,J]=pe("remember-pwd","false"),[v,F]=d(!1),[W,q]=P(async()=>v()?w.post("/auth/login/ldap",{username:s(),password:a(),otp_code:u()}):w.post("/auth/login/hash",{username:s(),password:Re(a()),otp_code:u()})),[,Y]=P((t,r,g,M)=>w.post("/authn/webauthn_finish_login?username="+g,JSON.stringify(r),{headers:{session:t},signal:M})),[,Q]=P((t,r)=>w.get("/authn/webauthn_begin_login?username="+t,{signal:r})),{searchParams:x,to:L}=B(),X=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,Z=I("webauthn_login_enabled"),ee=async()=>{H(!$())};let C=null;const z=async t=>{if(!Ae()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await X())return;C==null||C.abort();const r=new AbortController;C=r,p();const g=t?"":s();!t&&k()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const M=await Q(g,r.signal);_e(M,async K=>{try{const i=Ee(K.options);i.signal=r.signal,t&&(i.mediation="conditional");const oe=await Me(i),re=await Y(K.session,oe,g,r.signal);j(re,se=>{f.success(n("login.success")),p(se.token),L(decodeURIComponent(x.redirect||b||"/"),!0)})}catch(i){i instanceof Error&&i.name!="AbortError"&&f.error(i.message)}})},A=async()=>{if($())await z();else{k()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",a())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await q();j(t,r=>{f.success(n("login.success")),p(r.token),L(decodeURIComponent(x.redirect||b||"/"),!0)},(r,g)=>{!E()&&g===402?te(!0):f.error(r)})}},[E,te]=d(!1),D=I("ldap_login_enabled"),ne=_("ldap_login_tips");return D&&F(!0),he(()=>{z(!0)}),e(Ce,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(me,{get bgColor(){return S()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(R,{alignItems:"center",justifyContent:"space-around",get children(){return[e(fe,{mr:"$2",boxSize:"$12",get src(){return y()}}),e(we,{color:"$info9",fontSize:"$2xl",get children(){return c()}})]}}),e(m,{get when(){return!E()},get fallback(){return e(O,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return u()},onInput:t=>U(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&A()}})},get children(){return[e(O,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return s()},onInput:t=>h(t.currentTarget.value)}),e(m,{get when(){return!$()},get children(){return e(O,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return a()},onInput:t=>o(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&A()}})}}),e(R,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(G,{get checked(){return k()==="true"},onChange:()=>J(k()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(be,{color:"$success9",as:Se,href:"https://peifeng.li/cloud-help",get children(){return n("login.help")}})]}})]}}),e($e,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!$()},get children(){return[e(T,{w:"$full",colorScheme:"danger",onClick:()=>{p(),L(decodeURIComponent(x.redirect||b||"/"),!0)},get children(){return n("login.use_guest")}}),e(T,{colorScheme:"warning",w:"$full",onClick:()=>{E()?U(""):(h(""),o(""))},get children(){return n("login.clear")}})]}}),e(T,{colorScheme:"success",w:"$full",get loading(){return W()},onClick:A,get children(){return n("login.login")}})]}}),e(m,{when:D,get children(){return e(G,{w:"$full",get checked(){return v()===!0},onChange:()=>F(!v()),children:ne})}}),e(R,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(xe,{}),e(Oe,{}),e(m,{when:Z,get children(){return e(V,{cursor:"pointer",boxSize:"$8",as:Le,p:"$0_5",onclick:ee})}}),e(ke,{})]}})]}})}})};export{ze as default};
