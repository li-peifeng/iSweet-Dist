import{cg as le,an as I,a4 as _,d as W,cb as b,ch as C,r as q,x as e,aW as J,br as w,ci as ce,cj as ue,ck as ge,a7 as D,b as de,A as pe,B as p,cl as he,ba as U,q as me,ai as fe,bX as A,aK as we,bW as be,S as m,L as M,bc as G,ah as Ce,a0 as Se,aH as $e,Q as O,bC as ke,aN as _e,n as f,bs as Ie,cm as H}from"./index-af74a726.js";import{F as ye,f as ve,a as Le,S as xe,g as Ee}from"./index-c4ec7100.js";import{s as Pe,g as Re,a as Ue}from"./webauthn-json.browser-ponyfill-f2f06d6e.js";const Ae="https://github.com/alist-org/alist";function Me(c){return le(`${c}-${Ae}`)}const Oe=()=>{const c=I("sso_login_enabled"),y=_("sso_login_platform"),n=I("sso_compatibility_mode"),{searchParams:u,to:S}=W(),s=u.token;s!=null&&s!=""&&(b(s),S(decodeURIComponent(u.redirect||C||"/"),!0));function h(i){const o=i.data;o.token&&(b(o.token),S(decodeURIComponent(u.redirect||C||"/"),!0))}if(window.addEventListener("message",h),q(()=>{window.removeEventListener("message",h)}),c){const i=()=>{const g=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=g;return}window.open(g,"authPopup","width=500,height=600")};let o;switch(y){case"Github":o=ve;break;case"Microsoft":o=ge;break;case"Google":o=ue;break;case"Dingtalk":o=ce;break;default:o=ye}return e(J,{cursor:"pointer",boxSize:"$8",as:o,p:"$0_5",onclick:i})}},Ke=()=>{const c=_("logo").split(`
`),y=D(c[0],c.pop()),n=de(),u=pe(()=>`${_("site_title")}`);Le(u);const S=D("white","$neutral1"),[s,h]=p(localStorage.getItem("username")||""),[i,o]=p(localStorage.getItem("password")||""),[g,T]=p(""),[$,V]=p(!1),[k,Q]=he("remember-pwd","false"),[v,F]=p(!1),[X,Y]=U(async()=>v()?w.post("/auth/login/ldap",{username:s(),password:i(),otp_code:g()}):w.post("/auth/login/hash",{username:s(),password:Me(i()),otp_code:g()})),[,Z]=U((t,r,d,R)=>w.post("/authn/webauthn_finish_login?username="+d,JSON.stringify(r),{headers:{session:t},signal:R})),[,ee]=U((t,r)=>w.get("/authn/webauthn_begin_login?username="+t,{signal:r})),{searchParams:L,to:x}=W(),te=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,z=I("webauthn_login_enabled"),ne=async()=>{V(!$())};let a=null;const K=async t=>{if(!Pe()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await te())return;a==null||a.abort();const r=new AbortController;a=r;const d=t?"":s();!t&&k()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const R=await ee(d,r.signal);Ie(R,async B=>{try{const l=Re(B.options);l.signal=r.signal,t&&(l.mediation="conditional");const se=await Ue(l),ae=await Z(B.session,se,d,r.signal);H(ae,ie=>{f.success(n("login.success")),b(ie.token),x(decodeURIComponent(L.redirect||C||"/"),!0)})}catch(l){l instanceof Error&&l.name!="AbortError"&&f.error(l.message)}})},N=()=>a==null?void 0:a.abort();me(()=>{z&&(window.addEventListener("beforeunload",N),K(!0))}),q(()=>{a==null||a.abort(),window.removeEventListener("beforeunload",N)});const E=async()=>{if($())await K();else{k()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",i())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await Y();H(t,r=>{f.success(n("login.success")),b(r.token),x(decodeURIComponent(L.redirect||C||"/"),!0)},(r,d)=>{!P()&&d===402?oe(!0):f.error(r)})}},[P,oe]=p(!1),j=I("ldap_login_enabled"),re=_("ldap_login_tips");return j&&F(!0),e(_e,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(fe,{get bgColor(){return S()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(A,{alignItems:"center",justifyContent:"space-around",get children(){return[e(we,{mr:"$2",boxSize:"$12",get src(){return y()}}),e(be,{color:"$info9",fontSize:"$2xl",get children(){return u()}})]}}),e(m,{get when(){return!P()},get fallback(){return e(M,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return g()},onInput:t=>T(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})},get children(){return[e(M,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return s()},onInput:t=>h(t.currentTarget.value)}),e(m,{get when(){return!$()},get children(){return e(M,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return i()},onInput:t=>o(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})}}),e(A,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(G,{get checked(){return k()==="true"},onChange:()=>Q(k()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(Ce,{color:"$success9",as:Se,href:"https://peifeng.li/cloud-help",get children(){return n("login.help")}})]}})]}}),e($e,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!$()},get children(){return[e(O,{w:"$full",colorScheme:"danger",onClick:()=>{b(),x(decodeURIComponent(L.redirect||C||"/"),!0)},get children(){return n("login.use_guest")}}),e(O,{colorScheme:"warning",w:"$full",onClick:()=>{P()?T(""):(h(""),o(""))},get children(){return n("login.clear")}})]}}),e(O,{colorScheme:"success",w:"$full",get loading(){return X()},onClick:E,get children(){return n("login.login")}})]}}),e(m,{when:j,get children(){return e(G,{w:"$full",get checked(){return v()===!0},onChange:()=>F(!v()),children:re})}}),e(A,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(xe,{}),e(Oe,{}),e(m,{when:z,get children(){return e(J,{cursor:"pointer",boxSize:"$8",as:Ee,p:"$0_5",onclick:ne})}}),e(ke,{})]}})]}})}})};export{Ke as default};
