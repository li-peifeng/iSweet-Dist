import{ce as ne,aO as _,V as $,b as U,ca as g,cf as F,e as oe,h as e,aL as D,bi as w,cg as se,ch as re,ci as ae,Y as R,a as ie,k as le,m as u,cj as ce,b1 as L,o as ue,a8 as ge,bW as x,az as de,bV as he,S as m,I as O,b3 as j,a7 as pe,O as me,aw as fe,C as A,bt as we,aC as be,n as f,bj as Se,ck as K}from"./index.57bd7073.js";import{F as ke,f as $e,a as _e,S as Ce,g as ye}from"./index.9a0b07e0.js";import{s as Ie,g as ve,a as Le}from"./webauthn-json.browser-ponyfill.1c672167.js";const xe="https://github.com/alist-org/alist";function Oe(i){return ne(`${i}-${xe}`)}const Ae=()=>{const i=_("sso_login_enabled"),C=$("sso_login_platform"),n=_("sso_compatibility_mode"),{searchParams:l,to:b}=U(),s=l.token;s!=null&&s!=""&&(g(s),b(decodeURIComponent(l.redirect||F||"/"),!0));function d(r){const o=r.data;o.token&&(g(o.token),b(decodeURIComponent(l.redirect||F||"/"),!0))}if(window.addEventListener("message",d),oe(()=>{window.removeEventListener("message",d)}),i){const r=()=>{const c=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=c;return}window.open(c,"authPopup","width=500,height=600")};let o;switch(C){case"Github":o=$e;break;case"Microsoft":o=ae;break;case"Google":o=re;break;case"Dingtalk":o=se;break;default:o=ke}return e(D,{cursor:"pointer",boxSize:"$8",as:o,p:"$0_5",onclick:r})}},Te=()=>{const i=$("logo").split(`
`),C=R(i[0],i.pop()),n=ie(),l=le(()=>`${$("site_title")}`);_e(l);const b=R("white","$neutral1"),[s,d]=u(localStorage.getItem("username")||""),[r,o]=u(localStorage.getItem("password")||""),[c,E]=u(""),[S,G]=u(!1),[k,N]=ce("remember-pwd","false"),[y,P]=u(!1),[V,B]=L(async()=>y()?w.post("/auth/login/ldap",{username:s(),password:r(),otp_code:c()}):w.post("/auth/login/hash",{username:s(),password:Oe(r()),otp_code:c()})),[,W]=L((t,a,h)=>w.post("/authn/webauthn_finish_login?username="+h,JSON.stringify(a),{headers:{session:t}})),[,H]=L(t=>w.get("/authn/webauthn_begin_login?username="+t));U();const J=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,q=_("webauthn_login_enabled"),Y=async()=>{G(!S())},M=async t=>{if(!Ie()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await J())return;g();const a=t?"":s();!t&&k()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const h=await H(a);Se(h,async z=>{try{const p=ve(z.options);t&&(p.mediation="conditional");const Z=await Le(p),ee=await W(z.session,Z,a);K(ee,te=>{f.success(n("login.success")),g(te.token),window.location.href="/"})}catch(p){p instanceof Error&&f.error(p.message)}})},I=async()=>{if(S())await M();else{k()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",r())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await B();K(t,a=>{f.success(n("login.success")),g(a.token),window.location.href="/"},(a,h)=>{!v()&&h===402?Q(!0):f.error(a)})}},[v,Q]=u(!1),T=_("ldap_login_enabled"),X=$("ldap_login_tips");return T&&P(!0),ue(()=>{M(!0)}),e(be,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(ge,{get bgColor(){return b()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(x,{alignItems:"center",justifyContent:"space-around",get children(){return[e(de,{mr:"$2",boxSize:"$12",get src(){return C()}}),e(he,{color:"$info9",fontSize:"$2xl",get children(){return l()}})]}}),e(m,{get when(){return!v()},get fallback(){return e(O,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return c()},onInput:t=>E(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&I()}})},get children(){return[e(O,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return s()},onInput:t=>d(t.currentTarget.value)}),e(m,{get when(){return!S()},get children(){return e(O,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return r()},onInput:t=>o(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&I()}})}}),e(x,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(j,{get checked(){return k()==="true"},onChange:()=>N(k()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(pe,{color:"$success9",as:me,href:"https://peifeng.li/cloud-help",get children(){return n("login.help")}})]}})]}}),e(fe,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!S()},get children(){return[e(A,{w:"$full",colorScheme:"danger",onClick:()=>{g(),window.location.href="/"},get children(){return n("login.use_guest")}}),e(A,{colorScheme:"warning",w:"$full",onClick:()=>{v()?E(""):(d(""),o(""))},get children(){return n("login.clear")}})]}}),e(A,{colorScheme:"success",w:"$full",get loading(){return V()},onClick:I,get children(){return n("login.login")}})]}}),e(m,{when:T,get children(){return e(j,{w:"$full",get checked(){return y()===!0},onChange:()=>P(!y()),children:X})}}),e(x,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(Ce,{}),e(Ae,{}),e(m,{when:q,get children(){return e(D,{cursor:"pointer",boxSize:"$8",as:ye,p:"$0_5",onclick:Y})}}),e(we,{})]}})]}})}})};export{Te as default};
