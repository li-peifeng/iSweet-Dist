import{cf as se,ad as C,V as _,b as G,cb as h,cg as D,e as re,h as e,aM as N,bh as w,ch as ae,ci as ie,cj as le,Y as K,a as ce,k as ue,m as d,ck as ge,b0 as A,o as de,a8 as he,bX as E,aA as pe,bW as me,S as m,I as M,b2 as U,a7 as fe,O as we,ax as be,C as O,bs as Se,aD as ke,n as f,bi as $e,cl as j}from"./index.bacd141b.js";import{F as _e,f as Ce,a as ye,S as Ie,g as ve}from"./index.7e66e217.js";import{s as xe,g as Le,a as Ae}from"./webauthn-json.browser-ponyfill.1c672167.js";const Ee="https://github.com/alist-org/alist";function Me(l){return se(`${l}-${Ee}`)}const Oe=()=>{const l=C("sso_login_enabled"),y=_("sso_login_platform"),n=C("sso_compatibility_mode"),{searchParams:c,to:b}=G(),r=c.token;r!=null&&r!=""&&(h(r),b(decodeURIComponent(c.redirect||D||"/"),!0));function p(a){const o=a.data;o.token&&(h(o.token),b(decodeURIComponent(c.redirect||D||"/"),!0))}if(window.addEventListener("message",p),re(()=>{window.removeEventListener("message",p)}),l){const a=()=>{const u=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=u;return}window.open(u,"authPopup","width=500,height=600")};let o;switch(y){case"Github":o=Ce;break;case"Microsoft":o=le;break;case"Google":o=ie;break;case"Dingtalk":o=ae;break;default:o=_e}return e(N,{cursor:"pointer",boxSize:"$8",as:o,p:"$0_5",onclick:a})}},Re=()=>{const l=_("logo").split(`
`),y=K(l[0],l.pop()),n=ce(),c=ue(()=>`${_("site_title")}`);ye(c);const b=K("white","$neutral1"),[r,p]=d(localStorage.getItem("username")||""),[a,o]=d(localStorage.getItem("password")||""),[u,P]=d(""),[S,B]=d(!1),[k,V]=ge("remember-pwd","false"),[I,T]=d(!1),[W,H]=A(async()=>I()?w.post("/auth/login/ldap",{username:r(),password:a(),otp_code:u()}):w.post("/auth/login/hash",{username:r(),password:Me(a()),otp_code:u()})),[,J]=A((t,s,g,L)=>w.post("/authn/webauthn_finish_login?username="+g,JSON.stringify(s),{headers:{session:t},signal:L})),[,q]=A((t,s)=>w.get("/authn/webauthn_begin_login?username="+t,{signal:s}));G();const X=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,Y=C("webauthn_login_enabled"),Q=async()=>{B(!S())};let $=null;const F=async t=>{if(!xe()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await X())return;$==null||$.abort();const s=new AbortController;$=s,h();const g=t?"":r();!t&&k()==="true"?localStorage.setItem("username",r()):localStorage.removeItem("username");const L=await q(g,s.signal);$e(L,async z=>{try{const i=Le(z.options);i.signal=s.signal,t&&(i.mediation="conditional");const te=await Ae(i),ne=await J(z.session,te,g,s.signal);j(ne,oe=>{f.success(n("login.success")),h(oe.token),window.location.href="/"})}catch(i){i instanceof Error&&i.name!="AbortError"&&f.error(i.message)}})},v=async()=>{if(S())await F();else{k()==="true"?(localStorage.setItem("username",r()),localStorage.setItem("password",a())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await H();j(t,s=>{f.success(n("login.success")),h(s.token),window.location.href="/"},(s,g)=>{!x()&&g===402?Z(!0):f.error(s)})}},[x,Z]=d(!1),R=C("ldap_login_enabled"),ee=_("ldap_login_tips");return R&&T(!0),de(()=>{F(!0)}),e(ke,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(he,{get bgColor(){return b()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(E,{alignItems:"center",justifyContent:"space-around",get children(){return[e(pe,{mr:"$2",boxSize:"$12",get src(){return y()}}),e(me,{color:"$info9",fontSize:"$2xl",get children(){return c()}})]}}),e(m,{get when(){return!x()},get fallback(){return e(M,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return u()},onInput:t=>P(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&v()}})},get children(){return[e(M,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return r()},onInput:t=>p(t.currentTarget.value)}),e(m,{get when(){return!S()},get children(){return e(M,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return a()},onInput:t=>o(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&v()}})}}),e(E,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(U,{get checked(){return k()==="true"},onChange:()=>V(k()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(fe,{color:"$success9",as:we,href:"https://peifeng.li/cloud-help",get children(){return n("login.help")}})]}})]}}),e(be,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!S()},get children(){return[e(O,{w:"$full",colorScheme:"danger",onClick:()=>{h(),window.location.href="/"},get children(){return n("login.use_guest")}}),e(O,{colorScheme:"warning",w:"$full",onClick:()=>{x()?P(""):(p(""),o(""))},get children(){return n("login.clear")}})]}}),e(O,{colorScheme:"success",w:"$full",get loading(){return W()},onClick:v,get children(){return n("login.login")}})]}}),e(m,{when:R,get children(){return e(U,{w:"$full",get checked(){return I()===!0},onChange:()=>T(!I()),children:ee})}}),e(E,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(Ie,{}),e(Oe,{}),e(m,{when:Y,get children(){return e(N,{cursor:"pointer",boxSize:"$8",as:ve,p:"$0_5",onclick:Q})}}),e(Se,{})]}})]}})}})};export{Re as default};
