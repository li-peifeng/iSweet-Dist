import{au as k,d as O,aW as S,b9 as F,r as m,c as t,as as M,cb as Z,bN as te,S as f,ay as Q,cf as je,cg as Ke,b5 as T,bO as we,d2 as $e,G as y,ba as b,n as E,aN as ee,a6 as N,cW as Ve,d4 as C,K as ye,d5 as He,cd as xe,q as R,j as Ue,z as qe,D as Je,J as D,w as Xe,cj as Qe,aK as K,cm as ve,d6 as _e,d7 as ke,az as re}from"./index.99a608b2.js";import{P as Ye}from"./Paginator.e05649d9.js";var L;(function(e){e[e.Pending=0]="Pending",e[e.Running=1]="Running",e[e.Succeeded=2]="Succeeded",e[e.Canceling=3]="Canceling",e[e.Canceled=4]="Canceled",e[e.Errored=5]="Errored",e[e.Failing=6]="Failing",e[e.Failed=7]="Failed",e[e.WaitingRetry=8]="WaitingRetry",e[e.BeforeRetry=9]="BeforeRetry"})(L||(L={}));const Ze={[L.Failed]:"danger",[L.Succeeded]:"success",[L.Canceled]:"neutral"},Ee=e=>{if(e.role<0)return null;const n=["info","neutral","accent"];return t(xe,{get colorScheme(){return n[e.role]},css:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},get children(){return e.name}})},et=e=>{const n=O();return t(xe,{get colorScheme(){var c;return(c=Ze[e.state])!=null?c:"info"},get children(){return n(`tasks.state.${e.state}`)}})},l=[{name:"name",textAlign:"left",w:k().role===2?"calc(100% - 660px)":"calc(100% - 560px)"},{name:"creator",textAlign:"center",w:k().role===2?"100px":"0"},{name:"state",textAlign:"center",w:"100px"},{name:"progress",textAlign:"left",w:"140px"},{name:"speed",textAlign:"center",w:"100px"},{name:"operation",textAlign:"right",w:"220px"}],Y=e=>Math.floor(e).toString().padStart(2,"0"),tt=e=>{const n=e/1e3%60,c=e/1e3/60%60,i=e/1e3/3600;return`${Y(i)}:${Y(c)}:${Y(n)}`},rt=e=>{const n=O(),c=e.done==="undone"?"cancel":"delete",i=e.done==="done"&&e.state===L.Failed,[d,u]=S(()=>F.post(`/task/${e.type}/${c}?tid=${e.id}`)),[x,g]=S(()=>F.post(`/task/${e.type}/retry?tid=${e.id}`)),[w,z]=m(!1),v=e.name.match(e.nameAnalyzer.regex),V=v===null?e.name:e.nameAnalyzer.title(v),h=e.start_time===null?-1:new Date(e.start_time).getTime(),W=e.end_time===null?new Date().getTime():new Date(e.end_time).getTime();let I="-";const G=(o,A)=>{let _=A/o,P="bytes/s";return _>1024&&(_/=1024,P="KB/s"),_>1024&&(_/=1024,P="MB/s"),_>1024&&(_/=1024,P="GB/s"),`${_.toFixed(2)} ${P}`};if(e.done){if(e.start_time!==e.end_time&&e.progress>0&&h!==-1){const o=(W-h)/1e3,A=e.total_bytes*e.progress/100;I=G(o,A)}}else if(e.prevProgress!==void 0&&e.prevFetchTime!==void 0){const o=(e.curFetchTime-e.prevFetchTime)/1e3,A=(e.progress-e.prevProgress)*e.total_bytes/100;I=G(o,A)}return t(f,{get when(){return!w()},get children(){return[t(M,{w:"$full",p:"$2",get children(){return[t(M,{get w(){return l[0].w},spacing:"$1",get children(){return[t(Z,{"on:click":o=>{o.stopPropagation()},get checked(){return e.local.selected},onChange:o=>{e.setLocal({selected:o.target.checked,expanded:e.local.expanded})}}),t(te,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:V})]}}),t(f,{get when(){return k().role===2},get children(){return t(Q,{get w(){return l[1].w},get children(){return t(Ee,{get name(){return e.creator},get role(){return e.creator_role}})}})}}),t(Q,{get w(){return l[2].w},get children(){return t(et,{get state(){return e.state}})}}),t(je,{get w(){return l[3].w},trackColor:"$info3",rounded:"$full",size:"sm",get value(){return e.progress},mr:"$1",get children(){return t(Ke,{color:"$info8",rounded:"$md"})}}),t(Q,{get w(){return l[1].w},get children(){return t(T,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:I})}}),t(we,{get w(){return l[5].w},gap:"$1",get children(){return[t($e,{}),t(f,{get when(){return e.canRetry},get children(){return t(y,{size:"sm",disabled:!i,display:i?"block":"none",get loading(){return x()},onClick:async()=>{const o=await g();b(o,()=>{E.info(n("tasks.retry")),z(!0)})},get children(){return n("tasks.retry")}})}}),t(y,{size:"sm",colorScheme:"danger",get loading(){return d()},onClick:async()=>{const o=await u();b(o,()=>{E.success(n("global.delete_success")),z(!0)})},get children(){return n(`global.${c}`)}}),t(y,{size:"sm",colorScheme:"neutral",onClick:()=>{e.setLocal({selected:e.local.selected,expanded:!e.local.expanded})},get children(){return ee(()=>!!e.local.expanded,!0)()?n("tasks.fold"):n("tasks.expand")}})]}})]}}),t(f,{get when(){return e.local.expanded},get children(){return t(N,{css:{wordBreak:"break-all",fontSize:"0.8em"},w:"$full",pl:"$2",pr:"$2",get children(){return[t(Ve,{templateColumns:"min-content 1fr",w:"$full",columnGap:"$4",mb:"$2",get children(){return[t(f,{when:h!==-1,get children(){return[t(C,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.time_elapsed")}}),t(C,{color:"$neutral9",get children(){return tt(W-h)}})]}}),t(f,{when:v!==null,get children(){return t(ye,{get each(){return Object.entries(e.nameAnalyzer.attrs)},children:o=>[t(C,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return o[0]}}),t(C,{color:"$neutral9",get children(){return o[1](v)}})]})}}),t(C,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.status")}}),t(C,{color:"$neutral9",get children(){return e.status}}),t(f,{get when(){return e.error},get children(){return[t(C,{color:"$danger9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.err")}}),t(C,{color:"$danger9",get children(){return e.error}})]}})]}}),t(He,{})]}})}})]}})},nt=e=>{const n=O(),[c,i]=S(()=>F.get(`/task/${e.type}/${e.done}`)),[d,u]=m([]),[x,g]=m("name"),[w,z]=m(!1),v={name:(r,a)=>r.name>a.name?1:-1,creator:(r,a)=>r.creator===a.creator?r.id>a.id?1:-1:r.creator>a.creator?1:-1,state:(r,a)=>r.state===a.state?r.id>a.id?1:-1:r.state>a.state?1:-1,progress:(r,a)=>r.progress===a.progress?r.id>a.id?1:-1:r.progress<a.progress?1:-1},V=R(()=>(r,a)=>(w()?-1:1)*v[x()](r,a)),h=async()=>{const r=await i();b(r,a=>{var me;const $=new Date().getTime(),de={},ge={},q={},ue={},he={};for(const s of d())de[s.id]=s.curFetchTime,ge[s.id]=s.prevFetchTime,q[s.id]=s.progress,ue[s.id]=s.prevProgress,he[s.id]=s.local;u((me=a==null?void 0:a.map(s=>{var fe;let J,X;s.progress===q[s.id]?(J=ge[s.id],X=ue[s.id]):(J=de[s.id],X=q[s.id]);const Ge=(fe=he[s.id])!=null?fe:{selected:!1,expanded:!1};return{...s,curFetchTime:$,prevFetchTime:J,prevProgress:X,local:Ge}}).sort(V()))!=null?me:[])})};if(h(),e.done==="undone"){const r=setInterval(h,2e3);Ue(()=>clearInterval(r))}const[W,I]=S(()=>F.post(`/task/${e.type}/clear_done`)),[G,o]=S(()=>F.post(`/task/${e.type}/clear_succeeded`)),[A,_]=S(()=>F.post(`/task/${e.type}/retry_failed`)),[P,Se]=m(""),[Fe,be]=m(new RegExp("")),[ze,ne]=m(!1);qe(()=>{try{be(new RegExp(P())),ne(!1)}catch{ne(!0)}});const[ae,Ae]=m(k().role!==2),H=R(()=>{const r=Fe(),a=ae();return $=>r.test($.name)&&(!a||$.creator===k().username)}),p=R(()=>d().filter(H())),le=R(()=>p().map(r=>r.local.selected).every(Boolean)),Pe=R(()=>p().map(r=>r.local.selected).some(Boolean)&&!le()),Re=r=>u(d().map(a=>(H()(a)&&(a.local.selected=r),a))),ce=R(()=>p().map(r=>r.local.expanded).every(Boolean)),De=r=>u(d().map(a=>(H()(a)&&(a.local.expanded=r),a))),se=()=>p().filter(r=>r.local.selected).map(r=>r.id),[Te,Be]=S(()=>F.post(`/task/${e.type}/retry_some`,se())),[Le,Oe]=S(()=>F.post(`/task/${e.type}/${ie}_some`,se())),oe=r=>{Object.entries(r).forEach(([a,$])=>{E.error(`${a}: ${$}`)})},[Ie,Me]=m(1),U=20,ie=e.done==="undone"?"cancel":"delete",Ne=R(()=>{const r=(Ie()-1)*U,a=r+U;return p().slice(r,a)}),B=r=>({fontWeight:"bold",fontSize:"$sm",color:"$neutral11",textAlign:r.textAlign}),j=r=>({cursor:"pointer",onClick:()=>{x()===r.name?z(!w()):Xe(()=>{g(r.name),z(!1)}),h()}}),We=r=>a=>u(d().map($=>($.id===r&&($.local=a),$)));return t(N,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[t(te,{size:"lg",get children(){return n(`tasks.${e.done}`)}}),t(M,{gap:"$2",flexWrap:"wrap",get children(){return[t(f,{get when(){return e.done==="done"},get children(){return[t(y,{colorScheme:"accent",get loading(){return c()},onClick:h,get children(){return n("global.refresh")}}),t(y,{get loading(){return A()},onClick:async()=>{const r=await _();b(r,()=>h())},get children(){return n("tasks.retry_failed")}}),t(y,{colorScheme:"danger",get loading(){return W()},onClick:async()=>{const r=await I();b(r,()=>h())},get children(){return n("global.clear")}}),t(y,{colorScheme:"success",get loading(){return G()},onClick:async()=>{const r=await o();b(r,()=>h())},get children(){return n("tasks.clear_succeeded")}})]}}),t(f,{get when(){return e.canRetry},get children(){return t(y,{colorScheme:"primary",get loading(){return Te()},onClick:async()=>{const r=await Be();b(r,a=>{oe(a),h()})},get children(){return n("tasks.retry_selected")}})}}),t(y,{colorScheme:"warning",get loading(){return Le()},onClick:async()=>{const r=await Oe();b(r,a=>{oe(a),h()})},get children(){return n(`tasks.${ie}_selected`)}}),t(Je,{width:"auto",get placeholder(){return n("tasks.filter")},get value(){return P()},onInput:r=>Se(r.target.value),get invalid(){return ze()}}),t(f,{get when(){return k().role===2},get children(){return t(Z,{get checked(){return ae()},onChange:r=>Ae(r.target.checked),get children(){return n("tasks.show_only_mine")}})}})]}}),t(N,{w:{"@initial":"1024px","@lg":"$full"},overflowX:"auto",shadow:"$md",rounded:"$lg",spacing:"$1",p:"$1",get children(){return[t(M,{class:"title",w:"$full",p:"$2",get children(){return[t(M,{get w(){return l[0].w},spacing:"$1",get children(){return[t(Z,{get disabled(){return p().length===0},get checked(){return le()},get indeterminate(){return Pe()},onChange:r=>Re(r.target.checked)}),t(T,D(()=>B(l[0]),()=>j(l[0]),{get children(){return n(`tasks.attr.${l[0].name}`)}}))]}}),t(f,{get when(){return k().role===2},get children(){return t(T,D({get w(){return l[1].w}},()=>B(l[1]),()=>j(l[1]),{get children(){return n(`tasks.attr.${l[1].name}`)}}))}}),t(T,D({get w(){return l[2].w}},()=>B(l[2]),()=>j(l[2]),{get children(){return n(`tasks.attr.${l[2].name}`)}})),t(T,D({get w(){return l[3].w}},()=>B(l[3]),()=>j(l[3]),{get children(){return n(`tasks.attr.${l[3].name}`)}})),t(T,D({get w(){return l[4].w}},()=>B(l[4]),{get children(){return n(`tasks.attr.${l[4].name}`)}})),t(we,{get w(){return l[5].w},gap:"$2",get children(){return[t($e,{}),t(T,D(()=>B(l[5]),{get children(){return n(`tasks.attr.${l[5].name}`)}})),t(y,{size:"xs",colorScheme:"neutral",onClick:()=>De(!ce()),get disabled(){return p().length===0},get children(){return ee(()=>!!ce(),!0)()?n("tasks.fold_all"):n("tasks.expand_all")}})]}})]}}),ee(()=>Ne().map(r=>t(rt,D(r,e,{get setLocal(){return We(r.id)}}))))]}}),t(Ye,{get total(){return p().length},defaultPageSize:U,onChange:r=>{Me(r)}})]}})},ot=e=>{const n=O();return t(N,{w:"$full",alignItems:"start",spacing:"$4",get children(){return[t(te,{size:"xl",get children(){return n(`tasks.${e.type}`)}}),t(N,{w:"$full",spacing:"$2",get children(){return t(ye,{each:["undone","done"],children:c=>t(nt,{get type(){return e.type},done:c,get canRetry(){return e.canRetry},get nameAnalyzer(){return e.nameAnalyzer}})})}})]}})},at=re("<a></a>"),pe=re("<p></p>"),lt=re('<a target="_blank"></a>'),Ce=(e,n)=>{const c=(e==="/"?"":e)+n,i=k().base_path==="/"?"":k().base_path,d=c.startsWith(i),[u,x]=m(!1);return d?(()=>{const g=at.cloneNode(!0);return g.$$mouseout=()=>x(!1),g.$$mouseover=()=>x(!0),K(g,c),ve(w=>{const z=u()?"text-decoration: underline":"",v=c.slice(i.length);return w._v$=_e(g,z,w._v$),v!==w._v$2&&ke(g,"href",w._v$2=v),w},{_v$:void 0,_v$2:void 0}),g})():(()=>{const g=pe.cloneNode(!0);return K(g,c),g})()},it=()=>{const e=O(),[n,c]=m(!1);return{regex:/^download (.+) to \((.+)\)$/,title:i=>i[1],attrs:{[e("tasks.attr.offline_download.url")]:i=>(()=>{const d=lt.cloneNode(!0);return d.$$mouseout=()=>c(!1),d.$$mouseover=()=>c(!0),K(d,()=>i[1]),ve(u=>{const x=n()?"text-decoration: underline":"",g=i[1];return u._v$3=_e(d,x,u._v$3),g!==u._v$4&&ke(d,"href",u._v$4=g),u},{_v$3:void 0,_v$4:void 0}),d})(),[e("tasks.attr.offline_download.path")]:i=>Ce("",i[2])}}},dt=()=>{const e=O();return{regex:/^transfer ((?:.*\/)?(.+)) to \[(.+)]$/,title:n=>n[2],attrs:{[e("tasks.attr.offline_download.transfer_src")]:n=>(()=>{const c=pe.cloneNode(!0);return K(c,()=>n[1]),c})(),[e("tasks.attr.offline_download.transfer_dst")]:n=>Ce("",n[3])}}};Qe(["mouseover","mouseout"]);export{ot as T,dt as a,Ce as b,it as g};
